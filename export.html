<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Export Data</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
body{margin:0;font-family:system-ui;background:#f4f6f8}
header{background:#0f766e;color:#fff;padding:16px;display:flex;align-items:center}
main{max-width:700px;margin:auto;padding:16px}
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:16px}
label{font-weight:600;display:block;margin-bottom:6px}
input{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb}
button{width:100%;padding:16px;border-radius:14px;border:none;background:#0f766e;color:#fff;font-size:16px;font-weight:700}
button:disabled{opacity:.5}
.count{font-size:42px;font-weight:700;color:#0f766e;text-align:center}
</style>
</head>

<body>

<header>
  <span class="material-icons" onclick="history.back()">arrow_back</span>
  <h2 style="margin-left:12px">Export Data</h2>
</header>

<main>

<div class="card">
  <label>From Date</label>
  <input type="date" id="from">
</div>

<div class="card">
  <label>To Date</label>
  <input type="date" id="to">
</div>

<div class="card">
  <div class="count" id="count">0</div>
  <div style="text-align:center" id="range"></div>
</div>

<button id="btn" onclick="exportCSV()" disabled>Export to CSV</button>

</main>

<script>
const f = document.getElementById("from");
const t = document.getElementById("to");
const btn = document.getElementById("btn");
const countEl = document.getElementById("count");
const rangeEl = document.getElementById("range");

const today = new Date();
t.value = today.toISOString().split("T")[0];
f.value = new Date(today.getTime() - 30*86400000).toISOString().split("T")[0];

f.addEventListener("change", load);
t.addEventListener("change", load);

function load(){
  const all = JSON.parse(localStorage.getItem("employees") || "[]");

  const from = new Date(f.value);
  const to = new Date(t.value);
  to.setHours(23,59,59,999); // ðŸ”´ IMPORTANT FIX

  const data = all.filter(e=>{
    if(!e.entryDate) return false;
    const d = new Date(e.entryDate);
    return d >= from && d <= to;
  });

  countEl.innerText = data.length;
  rangeEl.innerText = f.value + " â€” " + t.value;
  btn.disabled = data.length === 0;
  btn.dataset.data = JSON.stringify(data);
}

function exportCSV(){
  const data = JSON.parse(btn.dataset.data || "[]");
  if(!data.length) return;

  const headers = Object.keys(data[0]);
  const csv = [
    headers.join(","),
    ...data.map(r => headers.map(h => `"${(r[h]||"").replace(/"/g,'""')}"`).join(","))
  ].join("\n");

  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "employees_export.csv";
  a.click();
}

load();
</script>

</body>
</html>
